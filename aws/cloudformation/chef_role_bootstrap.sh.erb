#!/bin/bash -x
# UserData bootstrap script for CloudFormation stack instances.
# Note: Minimize changes to this script! Every time its contents change,
# the next CloudFormation update will reboot all servers using this script.

# Bootstrap prerequisites
apt-get update
apt-get -y install python3-pip curl
test "$(pip3 show awscli)" || pip3 install awscli

STACK=<%=stack_name%>
REGION=<%=region%>
S3_BUCKET=<%=s3_bucket%>
ENVIRONMENT=<%=environment%>
RUN_LIST='<%=run_list.to_json%>'
INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
NODE_NAME=<%=node_name%>
RESOURCE_ID=<%=resource_id%>

OPTIONS="<%=local_mode ? '-z' : ''%> -n ${NODE_NAME} -r '${RUN_LIST}' -e ${ENVIRONMENT}"

sudo -u ubuntu bash <<SH
set -o errexit
aws s3 cp s3://${S3_BUCKET}/chef/bootstrap-${STACK}.sh - | sudo bash -s -- ${OPTIONS}

<% if commit -%>
# sync with ci_build.rake#upgrade_frontend
cd \${HOME}/${ENVIRONMENT}
git pull --ff-only
git reset --hard <%=commit%>
sudo bundle install
rake build
<% end -%>
SH

[ $? -eq 0 ] && STATUS=SUCCESS || STATUS=FAILURE

aws cloudformation signal-resource \
  --unique-id ${INSTANCE_ID} \
  --stack-name ${STACK} \
  --logical-resource-id ${RESOURCE_ID} \
  --status ${STATUS} \
  --region ${REGION} \
  || true
